<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../nebula-element-mixin/nebula-element-mixin.html">

<script>
(function() {
  'use strict'

  // symbols for private members
  const fetchResources = Symbol()

  // symbols for protected members
  const observe = Symbol.for('Nebula.ElementMixin.observe')
  const fire = Symbol.for('Nebula.ElementMixin.fire')

  class NebulaResources extends Nebula.ElementMixin(Polymer.Element) {

    /**
     * Gets the custom element name.
     * @type {string}
     */
    static get is() { return 'nebula-resources' }

    /**
     * Gets the property definitions for data binding.
     * @type {Object}
     * @property {string} file - The name of the JSON file (with or without extension) to retrieve from the specified path.
     * @property {string} path - The data to validate against the constraints.
     * @property {Object} resources - The contents of the resource file.
     */
    static get properties() {
      return {
        file: {
          type: String
        },
        path: {
          type: String,
          value: '.'
        },
        resources: {
          type: Object,
          readOnly: true,
          notify: true
        }
      }
    }

    /**
     * Lifecycle callback invoked when a new element instance is created.
     */
    constructor() {
      super()
      this[observe]('file, path', this[fetchResources])
    }

    /**
     * Lifecycle callback handler triggered when data-binding initialization is complete.
     */
    ready() {
      super.ready();
      this.setAttribute('hidden', '')
    }

    /**
     * Fetches the resource file from the server and sets the <b>resources</b> property with the contents.
     */
    [fetchResources](file, path) {
      if (!(file && path)) return

      if (!/\/$/ig.test(path)) path = path + '/'
      if (!/.json$/ig.test(file)) file = file + '.json'
      const url = this.resolveUrl(path + file)

      fetch(url).then((response) => {
        return response.json()
      }).then((resources) => {
        this._setResources(resources)
        this[fire]('loaded', resources)
      }).catch((error) => {
        this[fire]('error', error)
      })
    }
  }

  customElements.define(NebulaResources.is, NebulaResources)
}())
</script>